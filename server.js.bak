var express = require('express');

var app = express.createServer();

// Configuration

app.set('views', __dirname + '/views');
app.set('view engine', 'ejs');


// Routes

app.get('/', function(req, res){
  res.render('edit', {locals: {
    title: 'NowJS + Express Example'
  }});
});

app.get('/index', function(req, res){
  res.render('index', {locals: {
    title: 'All accepted results'
  }});
});

app.listen(9001);


//Node here
var everyone = require("now").initialize(app);

everyone.now.distributeMessage= function(msg) {
  everyone.now.receiveMessage(this.now.name, msg, this.now.color );
}

function rand(n){
  return(Math.floor(Math.random()*n+1));
}


var pg = require('pg');
var conString = "pg://postgres:postgres@localhost:5432/polybri";

everyone.now.savepolygon=function(wkt)
{
    savePolygon(wkt);
}

function retrievePolygon(callback)
{
  var query = "SELECT ST_AsText(the_geom) as geometry FROM polygons";

  pg.connect(conString, function(err, client) {
    client.query(query, function(err, result) {
        if(err) {
         console.log(err);
        }
        else
        {
          return callback(result.rows[0].geometry);
        }
    });
  });
}

function savePolygon(wkt)
{
  var query = "INSERT INTO polygons (the_geom) VALUES (ST_GeomFromText('" + wkt + "'))" ;

  pg.connect(conString, function(err, client) {
    client.query(query, function(err, result) {
        if(err) {
         console.log(err);
        }
    });
  });
}